#!/bin/sh /etc/rc.common

START=99

start() {

logger -t tweak-cpu "Starting Tweak Cpu Core"

INTERRUPT=$(ls /proc/irq/ | sed '/default/d')
USB3_NUMBER=$(grep usb3 /proc/interrupts | awk -F: '{print $1}' | sed 's/^ //')

for I in ${INTERRUPT}; do
	if [[ ${I} = ${USB3_NUMBER} ]]; then
        	echo f > /proc/irq/${I}/smp_affinity 2>/dev/null
        else
        	echo f > /proc/irq/${I}/smp_affinity 2>/dev/null
        fi
        printf "%-10s" ${I}:
        cat /proc/irq/${I}/smp_affinity
done

default_ps="$(uci get "network.@globals[0].default_ps")"
[ -z "$default_ps" -o "$default_ps" == 0 ] && exit 0

IFACE=$(ls /sys/class/net)
	
for i in ${IFACE}; do
	ethtool -K $i gro on 2>/dev/null
	if [[ -e /sys/class/net/$i/queues/rx-0/rps_cpus ]]; then
		if [[ $i = "wwan0" ]]; then
			echo f > /sys/class/net/$i/queues/rx-0/rps_cpus
                       echo f > /sys/class/net/wwan0_1/queues/rx-0/rps_cpus

		else
			echo f > /sys/class/net/$i/queues/rx-0/rps_cpus
                        echo f > /sys/class/net/wwan0_1/queues/rx-0/rps_cpus

		fi
	fi
done

}

stop() {

logger -t tweak cpu "Stopping Tweak Cpu Core"

}
